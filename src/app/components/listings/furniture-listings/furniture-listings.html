<!-- ===================== -->
<!-- DETAIL VIEW OVERLAY -->
<!-- ===================== -->
<div class="detail-overlay" *ngIf="selectedListing" (click)="closeDetail()">
  <div class="detail-container" (click)="$event.stopPropagation()">

    <!-- Close -->
    <button class="close-btn" (click)="closeDetail()">
      <i class="bi bi-x-lg"></i>
    </button>

    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <span class="crumb" (click)="closeDetail()">Furniture</span>
      <span class="crumb-sep">/</span>
      <span class="crumb current">{{ selectedListing.title }}</span>
    </div>

    <div class="detail-content">

      <!-- LEFT -->
      <div class="detail-left">

        <!-- Image Carousel -->
        <div class="image-carousel">
          <button
            class="carousel-btn prev"
            *ngIf="selectedListing.images.length > 1"
            (click)="previousImage()">
            <i class="bi bi-chevron-left"></i>
          </button>

          <div class="main-image">
            <img
              [src]="selectedListing.images.length
                ? selectedListing.images[currentImageIndex]
                : selectedListing.image"
              [alt]="selectedListing.title" />
          </div>

          <button
            class="carousel-btn next"
            *ngIf="selectedListing.images.length > 1"
            (click)="nextImage()">
            <i class="bi bi-chevron-right"></i>
          </button>

          <div class="image-indicators" *ngIf="selectedListing.images.length > 1">
            <span
              *ngFor="let img of selectedListing.images; let i = index"
              class="indicator"
              [class.active]="i === currentImageIndex"
              (click)="selectImage(i)">
            </span>
          </div>
        </div>

        <!-- Description -->
        <div class="detail-section">
          <h1 class="listing-title">{{ selectedListing.title }}</h1>
          <p class="listing-description">{{ selectedListing.description }}</p>
        </div>

        <!-- Specs -->
        <div class="detail-section specifications">
          <h2 class="section-title">Specifications</h2>
          <div class="specs-grid">

            <div class="spec-item" *ngIf="selectedListing.condition">
              <div class="spec-value">{{ selectedListing.condition }}</div>
              <div class="spec-label">Condition</div>
            </div>

            <div class="spec-item" *ngIf="selectedListing.material">
              <div class="spec-value">{{ selectedListing.material }}</div>
              <div class="spec-label">Material</div>
            </div>

            <div
              class="spec-item"
              *ngIf="selectedListing.lengthCm && selectedListing.widthCm && selectedListing.heightCm">
              <div class="spec-value">
                {{ selectedListing.lengthCm }} √ó
                {{ selectedListing.widthCm }} √ó
                {{ selectedListing.heightCm }} cm
              </div>
              <div class="spec-label">Dimensions (L √ó W √ó H)</div>
            </div>

            <div class="spec-item" *ngIf="selectedListing.weight">
              <div class="spec-value">{{ selectedListing.weight }}</div>
              <div class="spec-label">Weight</div>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="detail-right">

        <div class="price-card">
          <h3 class="price-label">Price</h3>
          <p class="price-value">
            {{ selectedListing.currency }} {{ selectedListing.price | number }}
          </p>
        </div>

        <div class="info-card">
          <h3 class="card-title">Location</h3>
          <p class="location-text">{{ selectedListing.location }}</p>
        </div>

        <div class="seller-card">
          <h3 class="card-title">Seller Information</h3>

          <div class="seller-profile">
            <img [src]="selectedListing.sellerImage" class="seller-avatar" />
            <div class="seller-info">
              <h4 class="seller-name">{{ selectedListing.sellerName }}</h4>
              <p class="seller-contact">{{ selectedListing.sellerPhone }}</p>
            </div>
          </div>

          <button class="contact-btn call-btn" (click)="callSeller()">
            Call Now
          </button>

          <button class="contact-btn whatsapp-btn" (click)="chatWhatsApp()">
            <i class="bi bi-whatsapp"></i> WhatsApp
          </button>

          <!-- Chat -->
          <button
            class="contact-btn chat-btn"
            *ngIf="isLoggedIn"
            (click)="startChatWithSeller(selectedListing)">
            <i class="bi bi-chat-dots"></i> Chat on Dubilist
          </button>

          <p *ngIf="!isLoggedIn" class="login-hint">
            Login to chat with seller
          </p>
        </div>

        <!-- Favorite -->
        <button
          class="action-btn favorite-btn"
          *ngIf="isLoggedIn"
          (click)="toggleFavorite(selectedListing, $event)"
          [class.favorited]="selectedListing.isFavorite">
          <i class="bi"
             [class.bi-heart]="!selectedListing.isFavorite"
             [class.bi-heart-fill]="selectedListing.isFavorite"></i>
          {{ selectedListing.isFavorite ? 'Added to Favourites' : 'Add to Favourites' }}
        </button>

        <button class="action-btn report-btn" (click)="reportAd()">
          Report this Ad <i class="bi bi-flag"></i>
        </button>

      </div>
    </div>
  </div>
</div>

<!-- ===================== -->
<!-- LISTINGS PAGE -->
<!-- ===================== -->
<div class="mt-5">
<div class="listings-page" [class.hidden]="selectedListing">

  <!-- FILTER SIDEBAR (DESKTOP) -->
  <aside class="filters-sidebar d-none d-md-block">
    <div class="filters-container">
      <h2 class="filters-title">Filters</h2>

      <section class="filter-section">
        <h3 class="section-label">Sort by</h3>
        <div class="sort-buttons">
          <button class="sort-btn"
                  [class.active]="isSortSelected('newest')"
                  (click)="selectSortBy('newest')">Newest</button>
          <button class="sort-btn"
                  [class.active]="isSortSelected('price-low')"
                  (click)="selectSortBy('price-low')">Price Low ‚Üí High</button>
          <button class="sort-btn"
                  [class.active]="isSortSelected('price-high')"
                  (click)="selectSortBy('price-high')">Price High ‚Üí Low</button>
        </div>
      </section>

      <button class="apply-filters-btn" (click)="applyFilters()">
        Apply Filters
      </button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="listings-main">

    <!-- HEADER -->
    <div class="listings-header d-flex align-items-center justify-content-between">
      <h1 class="page-title">Furniture</h1>

      <!-- Mobile Filter Icon -->
      <button
        class="btn btn-outline-secondary d-md-none"
        data-bs-toggle="offcanvas"
        data-bs-target="#mobileFilters">
        <i class="bi bi-funnel"></i>
      </button>
    </div>

    <!-- SEARCH -->
    <div class="search-container">
      <i class="bi bi-search search-icon"></i>
      <input
        class="search-input"
        placeholder="Search furniture..."
        [(ngModel)]="searchQuery"
        (keyup.enter)="onSearch()" />
    </div>

    <!-- LOADING -->
    <div class="loading-state" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Loading furniture...</p>
    </div>

    <!-- GRID -->
    <div
      class="listings-grid"
      *ngIf="!isLoading"
      (window:scroll)="onScroll()">

      <div
        *ngFor="let listing of paginatedListings"
        class="listing-card"
        (click)="viewListing(listing.id)">

        <div class="card-image">
          <img [src]="listing.image" [alt]="listing.title" />

          <button
            class="favorite-btn"
            *ngIf="isLoggedIn"
            (click)="toggleFavorite(listing, $event)">
            <i class="bi"
               [ngClass]="listing.isFavorite ? 'bi-heart-fill' : 'bi-heart'"></i>
          </button>
        </div>

        <div class="card-content">
          <h3 class="listing-title">{{ listing.title }}</h3>
          <p class="listing-price">
            {{ listing.currency }} {{ listing.price | number }}
          </p>
          <p class="listing-location">{{ listing.location }}</p>
        </div>
      </div>
    </div>

    <!-- LOADERS -->
    <div class="infinite-loader" *ngIf="isFetchingMore">
      <div class="spinner-border text-primary"></div>
    </div>

    <div
      class="no-more-listings text-center"
      *ngIf="allLoaded && paginatedListings.length">
      No more furniture üõãÔ∏è
    </div>

  </main>
</div>
</div>

<!-- ===================== -->
<!-- MOBILE FILTER OFFCANVAS -->
<!-- ===================== -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileFilters">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Filters</h5>
    <button class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body">
    <section class="filter-section">
      <h3 class="section-label">Sort by</h3>
      <div class="sort-buttons">
        <button class="sort-btn" (click)="selectSortBy('newest')">Newest</button>
        <button class="sort-btn" (click)="selectSortBy('price-low')">Price Low ‚Üí High</button>
        <button class="sort-btn" (click)="selectSortBy('price-high')">Price High ‚Üí Low</button>
      </div>
    </section>

    <button
      class="apply-filters-btn w-100"
      data-bs-dismiss="offcanvas"
      (click)="applyFilters()">
      Apply Filters
    </button>
  </div>
</div>
